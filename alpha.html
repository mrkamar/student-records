<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Continue | Student Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #121214;
      color: #e0e0e0;
      font-family: 'Fira Mono', monospace;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      background-color: #1f2024;
      border: none;
      color: #e0e0e0;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    .form-control,
    .form-select {
      background-color: #121214;
      border: 1.5px solid #7affc4;
      color: #7affc4;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #55e6b8;
      box-shadow: 0 0 0 0.25rem #55e6b866;
      background-color: #18191d;
      color: #7affc4;
    }

    .btn-primary {
      background-color: #55e6b8;
      border: none;
      color: #121214;
      font-weight: bold;
    }

    .btn-primary:hover {
      background-color: #7affc4;
      color: #121214;
    }

    .progress-bar {
      background-color: #55e6b8;
    }

    .alert {
      font-family: 'Fira Mono', monospace;
    }
  </style>
</head>
<body>
  <div class="container px-3">
    <div class="card p-4 w-100" style="max-width: 420px;">
      <h4 class="mb-4 text-center text-info">Student Verification</h4>

      <div class="mb-3">
        <label for="dataset" class="form-label">Select Program</label>
        <select id="dataset" class="form-select">
          <option value="morning">Morning (Regular)</option>
          <option value="spat">SPAT (Evening)</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="matricNo" class="form-label">Matric Number</label>
        <input type="text" id="matricNo" class="form-control" placeholder="Enter your Matric Number" />
      </div>

      <div class="d-grid">
        <button id="continueBtn" class="btn btn-primary">Continue</button>
      </div>

      <div class="progress mt-4 d-none" id="progressContainer">
        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
      </div>

      <div id="message" class="mt-3"></div>
    </div>
  </div>

  <script>
    const urls = {
      morning: "https://raw.githubusercontent.com/mrkamar/student-records/refs/heads/main/morning.csv",
      spat: "https://raw.githubusercontent.com/mrkamar/student-records/refs/heads/main/spat.csv",
    };

    const btn = document.getElementById("continueBtn");
    const messageEl = document.getElementById("message");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");

    btn.addEventListener("click", async () => {
      const dataset = document.getElementById("dataset").value;
      const matricNo = document.getElementById("matricNo").value.trim();

      messageEl.innerHTML = "";
      progressContainer.classList.remove("d-none");
      progressBar.style.width = "5%";

      if (!matricNo) {
        progressContainer.classList.add("d-none");
        messageEl.innerHTML = `<div class="alert alert-warning mt-2">Please enter your Matric Number.</div>`;
        return;
      }

      try {
        const res = await fetch(urls[dataset], { cache: "no-store" });
        const text = await res.text();
        progressBar.style.width = "40%";

        const lines = text.trim().split("\n");
        const headers = lines[0].replace(/"/g, "").split(",");
        const records = lines.slice(1).map(line => {
          const cells = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)
                         ?.map(cell => cell.replace(/"/g, "")) || [];
          const obj = {};
          headers.forEach((h, i) => (obj[h.trim()] = (cells[i] || "").trim()));
          return obj;
        });

        progressBar.style.width = "70%";

        const found = records.some(row => (row["Matric No"] || "").toLowerCase() === matricNo.toLowerCase());

        progressBar.style.width = "100%";

        setTimeout(() => {
          progressContainer.classList.add("d-none");
          progressBar.style.width = "0%";

          if (found) {
            // Success
            messageEl.innerHTML = `<div class="alert alert-success">✅ Found! You can now continue...</div>`;
            setTimeout(() => {
              window.location.href = "index.html";
            }, 1500);
          } else {
            // Not found
            messageEl.innerHTML = `<div class="alert alert-danger">❌ Matric Number not found.</div>`;
          }
        }, 500);

      } catch (err) {
        progressContainer.classList.add("d-none");
        messageEl.innerHTML = `<div class="alert alert-danger">An error occurred while checking the record. Please try again.</div>`;
        console.error(err);
      }
    });
  </script>
</body>
</html>
